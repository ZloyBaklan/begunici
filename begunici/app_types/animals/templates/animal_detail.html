{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
/* Стили для секции окотов */
.lambing-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    background-color: #f9f9f9;
}

.lambing-card.active {
    border-color: #28a745;
    background-color: #d4edda;
}

.lambing-card.completed {
    border-color: #6c757d;
    background-color: #e9ecef;
}

.lambing-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 10px;
}

.lambing-actions {
    text-align: right;
}

.lambing-actions button {
    margin-left: 5px;
}

#create-lambing-form {
    border: 1px solid #007bff;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    background-color: #e7f3ff;
}

.form-buttons {
    margin-top: 15px;
}

.form-buttons button {
    margin-right: 10px;
}

.planned-date {
    font-weight: bold;
    color: #dc3545;
}

.no-lambings {
    color: #6c757d;
    font-style: italic;
    padding: 20px;
    text-align: center;
}
</style>
<div id="animal-detail" data-tag-number="{{ animal.tag.tag_number }}" data-animal-type="{{ animal_type }}">
    <h1>Детальная страница: {{ animal.tag.tag_number }}</h1>

    <!-- Навигация -->
    <nav>
        <button id="analytics-button" type="button">Аналитика</button>
        {% if animal_type == 'ewe' %}
        <button id="convert-to-sheep-button" type="button" onclick="convertEweToSheep()">Преобразовать в овцу</button>
        {% endif %}
    </nav>

    <!-- Основная информация -->
    <h2>Основная информация</h2>
    <table>
        <tr><th>Бирка</th><td>{{ animal.tag.tag_number }}</td></tr>
        <tr><th>Статус</th><td>{{ animal.animal_status }}</td></tr>
        <tr><th>Возраст</th><td>{{ animal.age }} мес.</td></tr>
        {% if animal_type == 'maker' %}
        <tr><th>Рабочее состояние</th><td>{{ animal.working_condition }}</td></tr>
        {% endif %}
        <tr><th>Место</th><td>{{ animal.place.sheepfold }}</td></tr>
        <tr>
            <th>Мать</th>
            <td>Бирка:
                <span id="mother-display"></span>
                Ссылка: <a id="mother-link" href="#">перейти</a>
            </td>
        </tr>
        <tr>
            <th>Отец</th>
            <td>Бирка:
                <span id="father-display"></span>
                Ссылка: <a id="father-link" href="#">перейти</a>
            </td>
        </tr>
        
        
        <tr><th>Примечание</th><td>{{ animal.note }}</td></tr>
        
    </table>
    <!-- Последний вес -->
    <h3>Последний вес</h3>
    <div id="last-weight">
        <p>Дата последнего взвешивания: <span id="last-weight-date">-</span></p>
        <p>Вес: <span id="last-weight-value">-</span></p>
    </div>
    <!-- Форма добавления веса -->
    <h3>Добавить взвешивание</h3>
    <div id="add-weight-form">
        <label for="edit-weight-date">Дата:</label>
        <input type="date" id="edit-weight-date">
        <label for="edit-weight-value">Вес:</label>
        <input type="number" id="edit-weight-value" step="0.1">
        <button type="button" onclick="addWeightRecord()">Добавить</button>
    </div>

    <!-- Последняя ветобработка -->
    <h3>Последняя ветобработка</h3>
    <div>
        <p>Дата: <span id="last-vet-date">-</span></p>
        <p>Название обработки: <span id="last-vet-name">-</span></p>
        <p>Тип обработки: <span id="last-vet-type">-</span></p>
        <p>Препарат/материал: <span id="last-vet-medication">-</span></p>
        <p>Цель обработки: <span id="last-vet-purpose">-</span></p>
        <p>Комментарий: <span id="last-vet-comment">-</span></p>
    </div>



    <!-- Форма добавления ветобработки -->
    <h3>Добавить ветобработку</h3>
    <div id="add-vet-care-form">
        <select id="vet-treatment-select">
            <option value="">Выберите обработку</option>
        </select>

        <p id="treatment-type">Тип: -</p>
        <p id="treatment-description">Цель: -</p>
        <p id="treatment-medicine">Препарат: -</p>

        <label for="vet-treatment-date">Дата:</label>
        <input type="date" id="vet-treatment-date">

        <label for="vet-treatment-comments">Комментарии:</label>
        <textarea id="vet-treatment-comments" rows="3" placeholder="Добавьте комментарий (необязательно)"></textarea>

        <button type="button" onclick="addVetRecord()">Добавить</button>
    </div>








    <!-- Секция окотов (только для овец и ярок) -->
    {% if animal_type == 'sheep' or animal_type == 'ewe' %}
    <h2>Окоты</h2>
    
    <!-- Активные окоты -->
    <div id="active-lambings">
        <h3>Активные окоты</h3>
        <div id="active-lambings-list">
            <!-- Активные окоты будут загружены через JavaScript -->
        </div>
        
        <!-- Кнопка создания нового окота -->
        <button type="button" class="btn btn-primary" onclick="showCreateLambingForm()">Создать окот</button>
    </div>
    
    <!-- Форма создания окота -->
    <div id="create-lambing-form" style="display: none;">
        <h4>Создать новый окот</h4>
        <form>
            <label for="lambing-start-date">Дата начала (случки):</label>
            <input type="date" id="lambing-start-date" required>
            
            <label for="lambing-father-tag">Бирка отца (производитель/баран):</label>
            <input type="text" id="lambing-father-tag" placeholder="Введите бирку отца" required>
            
            <label for="lambing-note">Примечание (необязательно):</label>
            <textarea id="lambing-note" rows="2" placeholder="Дополнительная информация"></textarea>
            
            <div class="form-buttons">
                <button type="button" onclick="createLambing()">Создать окот</button>
                <button type="button" onclick="hideCreateLambingForm()">Отмена</button>
            </div>
        </form>
    </div>
    
    <!-- История окотов -->
    <div id="lambing-history">
        <h3>История окотов</h3>
        <div id="lambing-history-list">
            <!-- История окотов будет загружена через JavaScript -->
        </div>
    </div>
    {% endif %}

    <!-- Форма для редактирования -->
    <h2>Редактировать данные</h2>
    <form id="edit-animal-form">

        {% csrf_token %}

        <label>Бирка:</label>
        <input type="text" id="tag" value="{{ animal.tag.tag_number }}">

        <label>Статус животного:</label>
        <select id="animal_status"></select>

        <label>Дата рождения:</label>
        <input type="date" id="birth_date" value="{{ animal.birth_date }}">

        {% if animal_type == 'maker' %}
        <label>Племенной статус:</label>
        <input type="text" id="plemstatus" value="{{ animal.plemstatus }}">
        {% endif %}
        
        <label>Овчарня:</label>
        <select id="place"></select>

        {% if animal_type == 'maker' %}
        <label>Рабочее состояние:</label>
        <input type="text" id="working_condition" value="{{ animal.working_condition }}">
        {% endif %}

        <label>Примечание:</label>
        <input type="text" id="note" value="{{ animal.note }}">


        <button type="button" onclick="saveMakerDetails()">Сохранить</button>


        <h4>Редактировать родителей</h4>
        <p><small>Поля заполнены текущими родителями. Измените значения или очистите поля для удаления родителей.</small></p>
        
        <label>Мать (бирка):</label>
        <input type="text" id="mother-input" placeholder="Введите бирку матери или оставьте пустым для удаления">

        <label>Отец (бирка):</label>
        <input type="text" id="father-input" placeholder="Введите бирку отца или оставьте пустым для удаления">

        <button type="button" onclick="updateParents()">Обновить родителей</button>

    </form>

</body>
<!-- Модальное окно для завершения окота -->
<div class="modal fade" id="completeLambingModal" tabindex="-1" aria-labelledby="completeLambingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="completeLambingModalLabel">Завершение окота</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="lambing-completion-form">
                    <h6>Информация об окоте</h6>
                    <div class="mb-3">
                        <label class="form-label">Дата фактических родов:</label>
                        <input type="date" id="actual-lambing-date" class="form-control" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Количество родившихся ягнят:</label>
                        <input type="number" id="lambs-count" class="form-control" min="0" max="10" value="1">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Примечание к окоту:</label>
                        <textarea id="lambing-note" class="form-control" rows="2"></textarea>
                    </div>
                    
                    <hr>
                    
                    <div id="lambs-creation-section">
                        <h6>Создание ягнят</h6>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="create-lambs-checkbox" checked>
                            <label class="form-check-label" for="create-lambs-checkbox">
                                Создать записи о ягнятах
                            </label>
                        </div>
                        
                        <div id="lambs-forms-container">
                            <!-- Формы для создания ягнят будут добавлены через JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" onclick="completeLambingWithChildren()">Завершить окот</button>
            </div>
        </div>
    </div>
</div>

<style>
.lamb-form {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background-color: #f8f9fa;
}

.lamb-form h6 {
    color: #495057;
    margin-bottom: 10px;
}

.form-row {
    display: flex;
    gap: 15px;
    margin-bottom: 10px;
}

.form-row .form-group {
    flex: 1;
}

.form-group label {
    font-weight: 500;
    margin-bottom: 5px;
    display: block;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
}

.remove-lamb-btn {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}

.remove-lamb-btn:hover {
    background-color: #c82333;
}
</style>

<script src="{% static 'js/animal_detail.js' %}"></script>
{% endblock %}