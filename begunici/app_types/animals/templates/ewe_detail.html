{% extends 'base.html' %}

{% block title %}Ярка {{ ewe.tag.tag_number }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <h2>Ярка {{ ewe.tag.tag_number }}</h2>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Основная информация</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Номер бирки:</strong> {{ ewe.tag.tag_number }}</p>
                            <p><strong>Статус:</strong> {{ ewe.animal_status.status_type|default:"Не указан" }}</p>
                            <p><strong>Место:</strong> {{ ewe.place.sheepfold|default:"Не указано" }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Дата рождения:</strong> {{ ewe.birth_date|default:"Не указана" }}</p>
                            <p><strong>Возраст:</strong> {{ ewe.age|default:"Не указан" }} месяцев</p>
                            <p><strong>Примечание:</strong> {{ ewe.note|default:"Нет" }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">Родители</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Мать:</strong> 
                                {% if ewe.mother %}
                                    <a href="/animals/sheep/{{ ewe.mother.tag_number }}/info/">{{ ewe.mother.tag_number }}</a>
                                {% else %}
                                    Не указана
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Отец:</strong> 
                                {% if ewe.father %}
                                    <a href="/animals/maker/{{ ewe.father.tag_number }}/info/">{{ ewe.father.tag_number }}</a>
                                {% else %}
                                    Не указан
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">Дети</h5>
                    <div id="children-container">
                        <p>Загрузка...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Действия</h5>
                    <button class="btn btn-success btn-sm mb-2" onclick="convertToSheep()">Преобразовать в овцу</button>
                    <button class="btn btn-primary btn-sm mb-2" onclick="updateParents()">Обновить родителей</button>
                    <button class="btn btn-info btn-sm mb-2" onclick="viewStatusHistory()">История статусов</button>
                    <button class="btn btn-warning btn-sm mb-2" onclick="viewPlaceHistory()">История перемещений</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadChildren();
});

function loadChildren() {
    fetch(`/animals/ewe/{{ ewe.tag.tag_number }}/children/`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('children-container');
            if (data.length === 0) {
                container.innerHTML = '<p>Детей не найдено</p>';
            } else {
                let html = '<ul class="list-group">';
                data.forEach(child => {
                    html += `<li class="list-group-item">
                        <a href="/animals/ewe/${child.tag_number}/info/">${child.tag_number}</a>
                        <span class="badge badge-secondary ml-2">${child.animal_type}</span>
                    </li>`;
                });
                html += '</ul>';
                container.innerHTML = html;
            }
        })
        .catch(error => {
            console.error('Error loading children:', error);
            document.getElementById('children-container').innerHTML = '<p>Ошибка загрузки</p>';
        });
}

function convertToSheep() {
    if (confirm('Вы уверены, что хотите преобразовать ярку в овцу? Это действие нельзя отменить.')) {
        fetch(`/animals/ewe/{{ ewe.tag.tag_number }}/to_sheep/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status) {
                alert('Ярка успешно преобразована в овцу');
                window.location.href = `/animals/sheep/{{ ewe.tag.tag_number }}/info/`;
            } else {
                alert('Ошибка при преобразовании');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Произошла ошибка при преобразовании');
        });
    }
}

function updateParents() {
    const motherTag = prompt('Введите номер бирки матери (или оставьте пустым):');
    const fatherTag = prompt('Введите номер бирки отца (или оставьте пустым):');
    
    const data = {};
    if (motherTag !== null) data.mother_tag_number = motherTag || null;
    if (fatherTag !== null) data.father_tag_number = fatherTag || null;
    
    fetch(`/animals/ewe/{{ ewe.tag.tag_number }}/update_parents/`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Родители обновлены успешно');
            location.reload();
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при обновлении родителей');
    });
}

function viewStatusHistory() {
    fetch(`/animals/ewe/{{ ewe.tag.tag_number }}/status_history/`)
        .then(response => response.json())
        .then(data => {
            let message = 'История статусов:\n\n';
            data.forEach(status => {
                message += `${status.new_status.date_of_status}: ${status.new_status.status_type}\n`;
            });
            alert(message);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка загрузки истории статусов');
        });
}

function viewPlaceHistory() {
    fetch(`/animals/ewe/{{ ewe.tag.tag_number }}/place_history/`)
        .then(response => response.json())
        .then(data => {
            let message = 'История перемещений:\n\n';
            data.forEach(movement => {
                message += `${movement.new_place.date_of_transfer}: ${movement.new_place.new_place}\n`;
            });
            alert(message);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка загрузки истории перемещений');
        });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}

