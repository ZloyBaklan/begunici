{% extends 'base.html' %}

{% block title %}Овца {{ sheep.tag.tag_number }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <h2>Овца {{ sheep.tag.tag_number }}</h2>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Основная информация</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Номер бирки:</strong> {{ sheep.tag.tag_number }}</p>
                            <p><strong>Статус:</strong> {{ sheep.animal_status.status_type|default:"Не указан" }}</p>
                            <p><strong>Место:</strong> {{ sheep.place.sheepfold|default:"Не указано" }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Дата рождения:</strong> {{ sheep.birth_date|default:"Не указана" }}</p>
                            <p><strong>Возраст:</strong> {{ sheep.age|default:"Не указан" }} месяцев</p>
                            <p><strong>Примечание:</strong> {{ sheep.note|default:"Нет" }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">Родители</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Мать:</strong> 
                                {% if sheep.mother %}
                                    <a href="/animals/sheep/{{ sheep.mother.tag_number }}/info/">{{ sheep.mother.tag_number }}</a>
                                {% else %}
                                    Не указана
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Отец:</strong> 
                                {% if sheep.father %}
                                    <a href="/animals/maker/{{ sheep.father.tag_number }}/info/">{{ sheep.father.tag_number }}</a>
                                {% else %}
                                    Не указан
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">Окоты</h5>
                    <div id="lambing-container">
                        <p>Загрузка...</p>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">Дети</h5>
                    <div id="children-container">
                        <p>Загрузка...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Действия</h5>
                    <button class="btn btn-success btn-sm mb-2" onclick="addLambing()">Добавить окот</button>
                    <button class="btn btn-primary btn-sm mb-2" onclick="updateParents()">Обновить родителей</button>
                    <button class="btn btn-info btn-sm mb-2" onclick="viewStatusHistory()">История статусов</button>
                    <button class="btn btn-warning btn-sm mb-2" onclick="viewPlaceHistory()">История перемещений</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadLambingHistory();
    loadChildren();
});

function loadLambingHistory() {
    fetch(`/animals/sheep/{{ sheep.tag.tag_number }}/api/`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('lambing-container');
            if (data.lambing_history && data.lambing_history.length > 0) {
                let html = '<ul class="list-group">';
                data.lambing_history.forEach(lambing => {
                    html += `<li class="list-group-item">
                        <strong>Дата окота:</strong> ${lambing.actual_lambing_date || 'Не указана'}<br>
                        <strong>Производитель:</strong> ${lambing.maker || 'Не указан'}<br>
                        <strong>Количество ягнят:</strong> ${lambing.number_of_lambs || 'Не указано'}
                    </li>`;
                });
                html += '</ul>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<p>История окотов пуста</p>';
            }
        })
        .catch(error => {
            console.error('Error loading lambing history:', error);
            document.getElementById('lambing-container').innerHTML = '<p>Ошибка загрузки</p>';
        });
}

function loadChildren() {
    fetch(`/animals/sheep/{{ sheep.tag.tag_number }}/children/`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('children-container');
            if (data.length === 0) {
                container.innerHTML = '<p>Детей не найдено</p>';
            } else {
                let html = '<ul class="list-group">';
                data.forEach(child => {
                    html += `<li class="list-group-item">
                        <a href="/animals/sheep/${child.tag_number}/info/">${child.tag_number}</a>
                        <span class="badge badge-secondary ml-2">${child.animal_type}</span>
                    </li>`;
                });
                html += '</ul>';
                container.innerHTML = html;
            }
        })
        .catch(error => {
            console.error('Error loading children:', error);
            document.getElementById('children-container').innerHTML = '<p>Ошибка загрузки</p>';
        });
}

function addLambing() {
    const makerId = prompt('Введите номер бирки производителя:');
    if (!makerId) return;
    
    const actualLambingDate = prompt('Введите фактическую дату окота (YYYY-MM-DD):');
    if (!actualLambingDate) return;
    
    const lambsData = [];
    const numLambs = prompt('Введите количество ягнят:');
    if (numLambs) {
        for (let i = 0; i < parseInt(numLambs); i++) {
            const gender = prompt(`Пол ягненка ${i + 1} (male/female):`);
            const tagNumber = prompt(`Номер бирки ягненка ${i + 1}:`);
            if (gender && tagNumber) {
                lambsData.push({
                    gender: gender,
                    tag: tagNumber
                });
            }
        }
    }
    
    const data = {
        maker_id: makerId,
        actual_lambing_date: actualLambingDate,
        lambs_data: lambsData
    };
    
    fetch(`/animals/sheep/{{ sheep.tag.tag_number }}/add_lambing/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        alert('Окот добавлен успешно');
        loadLambingHistory();
        loadChildren();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при добавлении окота');
    });
}

function updateParents() {
    const motherTag = prompt('Введите номер бирки матери (или оставьте пустым):');
    const fatherTag = prompt('Введите номер бирки отца (или оставьте пустым):');
    
    const data = {};
    if (motherTag !== null) data.mother_tag_number = motherTag || null;
    if (fatherTag !== null) data.father_tag_number = fatherTag || null;
    
    fetch(`/animals/sheep/{{ sheep.tag.tag_number }}/update_parents/`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Родители обновлены успешно');
            location.reload();
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при обновлении родителей');
    });
}

function viewStatusHistory() {
    fetch(`/animals/sheep/{{ sheep.tag.tag_number }}/status_history/`)
        .then(response => response.json())
        .then(data => {
            let message = 'История статусов:\n\n';
            data.forEach(status => {
                message += `${status.new_status.date_of_status}: ${status.new_status.status_type}\n`;
            });
            alert(message);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка загрузки истории статусов');
        });
}

function viewPlaceHistory() {
    fetch(`/animals/sheep/{{ sheep.tag.tag_number }}/place_history/`)
        .then(response => response.json())
        .then(data => {
            let message = 'История перемещений:\n\n';
            data.forEach(movement => {
                message += `${movement.new_place.date_of_transfer}: ${movement.new_place.new_place}\n`;
            });
            alert(message);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка загрузки истории перемещений');
        });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}

