{% extends 'base.html' %}
{% load static %}

{% block title %}Главная{% endblock %}

{% block content %}
<div class="container">
    <h2>Добро пожаловать на ферму Бегуницы</h2>
    
    <!-- Статистика -->
    <div class="statistics-container">
        <h3>Статистика</h3>
        <div class="stats-cards">
            <div class="stat-card">
                <h4>Активные животные</h4>
                <div class="stat-number" id="total-active">-</div>
                <div class="stat-details">
                    <p>Производители: <span id="active-makers">-</span></p>
                    <p>Бараны: <span id="active-rams">-</span></p>
                    <p>Ярки: <span id="active-ewes">-</span></p>
                    <p>Овцы: <span id="active-sheep">-</span></p>
                </div>
            </div>
            
            <div class="stat-card">
                <h4>Архивировано (месяц)</h4>
                <div class="stat-number" id="total-archived">-</div>
                <div class="stat-details">
                    <div class="animal-type-section">
                        <strong>Производители:</strong> <span id="archived-makers-total">-</span>
                        <div class="status-breakdown" id="archived-makers-breakdown"></div>
                    </div>
                    <div class="animal-type-section">
                        <strong>Бараны:</strong> <span id="archived-rams-total">-</span>
                        <div class="status-breakdown" id="archived-rams-breakdown"></div>
                    </div>
                    <div class="animal-type-section">
                        <strong>Ярки:</strong> <span id="archived-ewes-total">-</span>
                        <div class="status-breakdown" id="archived-ewes-breakdown"></div>
                    </div>
                    <div class="animal-type-section">
                        <strong>Овцы:</strong> <span id="archived-sheep-total">-</span>
                        <div class="status-breakdown" id="archived-sheep-breakdown"></div>
                    </div>
                </div>
            </div>
            
            <div class="stat-card">
                <h4>Родилось (месяц)</h4>
                <div class="stat-number" id="total-born">-</div>
                <div class="stat-details">
                    <p>Бараны: <span id="born-rams">-</span></p>
                    <p>Ярки: <span id="born-ewes">-</span></p>
                </div>
            </div>
            
            <div class="stat-card">
                <h4>Статистика по годам</h4>
                <div class="year-selector">
                    <label for="year-select">Год:</label>
                    <select id="year-select">
                        <!-- Годы будут добавлены через JavaScript -->
                    </select>
                </div>
                <div class="yearly-stats" id="yearly-stats">
                    <div class="yearly-stat-section">
                        <strong>Прирост веса по месяцам:</strong>
                        <div id="avg-weight-gain">-</div>
                    </div>
                    <div class="yearly-stat-section">
                        <strong>Ветобработки:</strong>
                        <div id="vet-treatments">-</div>
                    </div>
                    <div class="yearly-stat-section">
                        <strong>Животные по статусам:</strong>
                        <div id="animals-by-status">-</div>
                    </div>
                    <div class="yearly-stat-section">
                        <strong>Рождения:</strong>
                        <div id="births-stats">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Навигация -->
    <div class="navigation-section">
        <h3>Выберите раздел:</h3>
        <ul>
            <li><a href="{% url 'veterinary:veterinary-management' %}">Управление технической информацией</a></li>
            <li><a href="{% url 'animals:animals' %}">Управление животными</a></li>
        </ul>
    </div>
    
    <!-- Кнопка бэкапа внизу страницы -->
    <div class="backup-section text-end mt-4">
        <button id="backupBtn" class="btn btn-warning backup-button" onclick="openBackupModal()">
            Сделать бэкап
        </button>
    </div>
</div>

<script>
// Загрузка статистики при загрузке страницы
document.addEventListener('DOMContentLoaded', async () => {
    // Инициализация селектора годов
    initYearSelector();
    
    try {
        const response = await fetch('/animals/api/dashboard-statistics/');
        const data = await response.json();
        
        // Всего активных
        document.getElementById('total-active').textContent = data.active_animals.total;
        document.getElementById('active-makers').textContent = data.active_animals.by_type.makers;
        document.getElementById('active-rams').textContent = data.active_animals.by_type.rams;
        document.getElementById('active-ewes').textContent = data.active_animals.by_type.ewes;
        document.getElementById('active-sheep').textContent = data.active_animals.by_type.sheep;
        
        // Архивировано
        document.getElementById('total-archived').textContent = data.archived_last_month.total;
        
        // Функция для создания детализации по статусам
        function createStatusBreakdown(statusData) {
            if (!statusData || statusData.length === 0) {
                return '';
            }
            
            const statusMap = {
                'Убыл': 'убыло',
                'Убой': 'убой', 
                'Продажа': 'продажа'
            };
            
            return statusData.map(item => {
                const statusName = statusMap[item.animal_status__status_type] || item.animal_status__status_type;
                return `<div>${statusName}: ${item.count}</div>`;
            }).join('');
        }
        
        // Производители
        document.getElementById('archived-makers-total').textContent = data.archived_last_month.by_type.makers.total;
        document.getElementById('archived-makers-breakdown').innerHTML = 
            createStatusBreakdown(data.archived_last_month.by_type.makers.by_status);
        
        // Бараны
        document.getElementById('archived-rams-total').textContent = data.archived_last_month.by_type.rams.total;
        document.getElementById('archived-rams-breakdown').innerHTML = 
            createStatusBreakdown(data.archived_last_month.by_type.rams.by_status);
        
        // Ярки
        document.getElementById('archived-ewes-total').textContent = data.archived_last_month.by_type.ewes.total;
        document.getElementById('archived-ewes-breakdown').innerHTML = 
            createStatusBreakdown(data.archived_last_month.by_type.ewes.by_status);
        
        // Овцы
        document.getElementById('archived-sheep-total').textContent = data.archived_last_month.by_type.sheep.total;
        document.getElementById('archived-sheep-breakdown').innerHTML = 
            createStatusBreakdown(data.archived_last_month.by_type.sheep.by_status);
        
        // Родилось
        document.getElementById('total-born').textContent = data.born_last_month.total;
        document.getElementById('born-rams').textContent = data.born_last_month.by_type.rams;
        document.getElementById('born-ewes').textContent = data.born_last_month.by_type.ewes;
    } catch (error) {
        console.error('Ошибка загрузки статистики:', error);
    }
    
    // Загружаем годовую статистику для текущего года
    loadYearlyStatistics(new Date().getFullYear());
    
    // Проверяем нужность автобэкапа
    try {
        const response = await fetch('/animals/api/backup/check-auto/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.created) {
            console.log('Автобэкап создан:', data.message);
        }
    } catch (error) {
        console.error('Ошибка проверки автобэкапа:', error);
    }
});

// Инициализация селектора годов
function initYearSelector() {
    const yearSelect = document.getElementById('year-select');
    const currentYear = new Date().getFullYear();
    
    // Добавляем годы от 2020 до текущего года
    for (let year = 2020; year <= currentYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYear) {
            option.selected = true;
        }
        yearSelect.appendChild(option);
    }
    
    // Обработчик изменения года
    yearSelect.addEventListener('change', (e) => {
        loadYearlyStatistics(parseInt(e.target.value));
    });
}

// Загрузка годовой статистики
async function loadYearlyStatistics(year) {
    // Показываем индикатор загрузки
    const containers = ['avg-weight-gain', 'vet-treatments', 'animals-by-status', 'births-stats'];
    containers.forEach(id => {
        const container = document.getElementById(id);
        if (container) {
            container.innerHTML = '<div style="text-align: center; padding: 20px;">⏳ Загрузка статистики...</div>';
        }
    });
    
    try {
        const response = await fetch(`/animals/api/yearly-statistics/?year=${year}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            console.error('Ошибка загрузки годовой статистики:', data.error);
            containers.forEach(id => {
                const container = document.getElementById(id);
                if (container) {
                    container.innerHTML = `<div style="color: red;">Ошибка: ${data.error}</div>`;
                }
            });
            return;
        }
        
        // Средний прирост веса
        displayWeightGain(data.monthly_weight_gain);
        
        // Ветобработки
        displayVetTreatments(data.veterinary_treatments);
        
        // Животные по статусам
        displayAnimalsByStatus(data.animals_by_status);
        
        // Рождения
        displayBirths(data.births);
        
    } catch (error) {
        console.error('Ошибка загрузки годовой статистики:', error);
        containers.forEach(id => {
            const container = document.getElementById(id);
            if (container) {
                container.innerHTML = `<div style="color: red;">Ошибка загрузки данных: ${error.message}</div>`;
            }
        });
    }
}

// Отображение среднего прироста веса
function displayWeightGain(monthlyData) {
    const container = document.getElementById('avg-weight-gain');
    
    if (!monthlyData || Object.keys(monthlyData).length === 0) {
        container.innerHTML = 'Нет данных';
        return;
    }
    
    const monthNames = [
        'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
        'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
    ];
    
    let html = '';
    let hasData = false;
    
    for (let i = 1; i <= 12; i++) {
        const monthKey = `month_${i}`;
        const monthName = monthNames[i - 1];
        
        if (monthlyData[monthKey] && monthlyData[monthKey].animals_count > 0) {
            const gain = monthlyData[monthKey].avg_gain;
            html += `<div>${monthName}: ${gain} кг</div>`;
            hasData = true;
        } else {
            html += `<div>${monthName}: - кг</div>`;
        }
    }
    
    if (!hasData) {
        container.innerHTML = 'Нет данных';
    } else {
        container.innerHTML = html;
    }
}

// Отображение ветобработок
function displayVetTreatments(treatments) {
    const container = document.getElementById('vet-treatments');
    
    if (!treatments || Object.keys(treatments).length === 0) {
        container.innerHTML = 'Нет данных';
        return;
    }
    
    const total = Object.values(treatments).reduce((sum, count) => sum + count, 0);
    let html = `<div><strong>Всего: ${total}</strong></div>`;
    
    // Показываем топ-3 обработки
    const sortedTreatments = Object.entries(treatments)
        .sort(([,a], [,b]) => b - a);
    
    const topTreatments = sortedTreatments.slice(0, 3);
    const remainingTreatments = sortedTreatments.slice(3);
    
    topTreatments.forEach(([treatment, count]) => {
        html += `<div>${treatment}: ${count}</div>`;
    });
    
    if (remainingTreatments.length > 0) {
        html += `<div class="expand-section">`;
        html += `<div class="expand-trigger" onclick="toggleExpand('vet-treatments', this)">`;
        html += `<small style="cursor: pointer; color: #007bff;">и ещё ${remainingTreatments.length}...</small>`;
        html += `</div>`;
        html += `<div class="expanded-content" style="display: none;">`;
        
        remainingTreatments.forEach(([treatment, count]) => {
            html += `<div>${treatment}: ${count}</div>`;
        });
        
        html += `<div class="collapse-trigger" onclick="toggleExpand('vet-treatments', this)" style="cursor: pointer; color: #007bff;">`;
        html += `<small>свернуть</small>`;
        html += `</div>`;
        html += `</div>`;
        html += `</div>`;
    }
    
    container.innerHTML = html;
}

// Отображение животных по статусам
function displayAnimalsByStatus(statusData) {
    const container = document.getElementById('animals-by-status');
    
    if (!statusData || Object.keys(statusData).length === 0) {
        container.innerHTML = 'Нет данных';
        return;
    }
    
    const total = Object.values(statusData).reduce((sum, count) => sum + count, 0);
    let html = `<div><strong>Всего: ${total}</strong></div>`;
    
    // Показываем топ-3 статуса
    const sortedStatuses = Object.entries(statusData)
        .sort(([,a], [,b]) => b - a);
    
    const topStatuses = sortedStatuses.slice(0, 3);
    const remainingStatuses = sortedStatuses.slice(3);
    
    topStatuses.forEach(([status, count]) => {
        html += `<div>${status}: ${count}</div>`;
    });
    
    if (remainingStatuses.length > 0) {
        html += `<div class="expand-section">`;
        html += `<div class="expand-trigger" onclick="toggleExpand('animals-by-status', this)">`;
        html += `<small style="cursor: pointer; color: #007bff;">и ещё ${remainingStatuses.length}...</small>`;
        html += `</div>`;
        html += `<div class="expanded-content" style="display: none;">`;
        
        remainingStatuses.forEach(([status, count]) => {
            html += `<div>${status}: ${count}</div>`;
        });
        
        html += `<div class="collapse-trigger" onclick="toggleExpand('animals-by-status', this)" style="cursor: pointer; color: #007bff;">`;
        html += `<small>свернуть</small>`;
        html += `</div>`;
        html += `</div>`;
        html += `</div>`;
    }
    
    container.innerHTML = html;
}

// Отображение рождений
function displayBirths(birthsData) {
    const container = document.getElementById('births-stats');
    
    if (!birthsData || birthsData.total === 0) {
        container.innerHTML = 'Нет данных';
        return;
    }
    
    container.innerHTML = `
        <div><strong>Всего: ${birthsData.total}</strong></div>
        <div>Мальчики: ${birthsData.boys}</div>
        <div>Девочки: ${birthsData.girls}</div>
    `;
}

// Функция для разворачивания/сворачивания секций
function toggleExpand(containerId, trigger) {
    const container = document.getElementById(containerId);
    const expandSection = trigger.closest('.expand-section');
    const expandTrigger = expandSection.querySelector('.expand-trigger');
    const expandedContent = expandSection.querySelector('.expanded-content');
    
    if (expandedContent.style.display === 'none') {
        // Разворачиваем
        expandTrigger.style.display = 'none';
        expandedContent.style.display = 'block';
    } else {
        // Сворачиваем
        expandTrigger.style.display = 'block';
        expandedContent.style.display = 'none';
    }
}
</script>

<!-- Модальное окно для бэкапа -->
<div class="modal fade" id="backupModal" tabindex="-1" aria-labelledby="backupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="backupModalLabel">Создание бэкапа базы данных</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="backup-info">
                    <p><strong>Последний бэкап:</strong> <span id="last-backup-info">Загрузка...</span></p>
                    <p>Вы уверены, что хотите создать новый бэкап базы данных?</p>
                </div>
                <div id="backup-status" style="display: none;">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2" id="backup-status-text">Подождите, бэкап создаётся...</p>
                    </div>
                </div>
                <div id="backup-result" style="display: none;">
                    <div class="alert" id="backup-result-alert">
                        <span id="backup-result-text"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancel-btn">Отмена</button>
                <button type="button" class="btn btn-warning" onclick="createBackup()" id="confirm-btn">Создать бэкап</button>
            </div>
        </div>
    </div>
</div>

<style>
.backup-button {
    padding: 12px 16px;
    font-weight: bold;
    border-radius: 4px;
    min-width: 120px;
}

.backup-section {
    margin-top: 2rem;
    padding-bottom: 2rem;
}

/* Исправление для навигационных ссылок */
.navigation-section a {
    color: white !important;
    text-decoration: none;
}

.navigation-section a:hover {
    color: white !important;
    text-decoration: none;
}

/* Стили для разворачиваемых секций */
.expand-section {
    margin-top: 4px;
}

.expand-trigger, .collapse-trigger {
    user-select: none;
    transition: color 0.2s ease;
}

.expand-trigger:hover, .collapse-trigger:hover {
    color: #0056b3 !important;
    text-decoration: underline;
}

.expanded-content {
    margin-top: 4px;
    padding-left: 8px;
    border-left: 2px solid #e9ecef;
}
</style>

<script>
// Функции для работы с бэкапами
let backupModal;

// Открытие модального окна бэкапа
async function openBackupModal() {
    // Загружаем информацию о последнем бэкапе
    await loadBackupInfo();
    
    // Сбрасываем состояние модального окна
    document.getElementById('backup-info').style.display = 'block';
    document.getElementById('backup-status').style.display = 'none';
    document.getElementById('backup-result').style.display = 'none';
    document.getElementById('confirm-btn').disabled = false;
    document.getElementById('cancel-btn').textContent = 'Отмена';
    
    // Показываем модальное окно
    backupModal = new bootstrap.Modal(document.getElementById('backupModal'));
    backupModal.show();
}

// Загрузка информации о последнем бэкапе
async function loadBackupInfo() {
    try {
        const response = await fetch('/animals/api/backup/info/');
        const data = await response.json();
        
        const lastBackupElement = document.getElementById('last-backup-info');
        
        if (data.last_backup) {
            lastBackupElement.innerHTML = `
                ${data.last_backup.type} - ${data.last_backup.date} 
                <small>(${data.last_backup.size})</small>
            `;
        } else {
            lastBackupElement.textContent = 'Бэкапы не найдены';
        }
    } catch (error) {
        console.error('Ошибка загрузки информации о бэкапе:', error);
        document.getElementById('last-backup-info').textContent = 'Ошибка загрузки';
    }
}

// Создание бэкапа
async function createBackup() {
    // Скрываем информацию и показываем статус
    document.getElementById('backup-info').style.display = 'none';
    document.getElementById('backup-status').style.display = 'block';
    document.getElementById('backup-result').style.display = 'none';
    
    // Отключаем кнопку подтверждения
    document.getElementById('confirm-btn').disabled = true;
    document.getElementById('cancel-btn').textContent = 'Отмена';
    
    try {
        const response = await fetch('/animals/api/backup/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        // Скрываем статус и показываем результат
        document.getElementById('backup-status').style.display = 'none';
        document.getElementById('backup-result').style.display = 'block';
        
        const alertElement = document.getElementById('backup-result-alert');
        const resultText = document.getElementById('backup-result-text');
        
        if (data.success) {
            alertElement.className = 'alert alert-success';
            resultText.textContent = 'Успех! Бэкап успешно создан.';
            
            // Закрываем модальное окно через 5 секунд
            setTimeout(() => {
                if (backupModal) {
                    backupModal.hide();
                }
            }, 5000);
        } else {
            alertElement.className = 'alert alert-danger';
            resultText.textContent = `Ошибка: ${data.error}`;
        }
        
        document.getElementById('cancel-btn').textContent = 'Закрыть';
        
    } catch (error) {
        console.error('Ошибка создания бэкапа:', error);
        
        document.getElementById('backup-status').style.display = 'none';
        document.getElementById('backup-result').style.display = 'block';
        
        const alertElement = document.getElementById('backup-result-alert');
        const resultText = document.getElementById('backup-result-text');
        
        alertElement.className = 'alert alert-danger';
        resultText.textContent = `Ошибка сети: ${error.message}`;
        
        document.getElementById('cancel-btn').textContent = 'Закрыть';
    }
}

// Функция для получения CSRF токена
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock %}